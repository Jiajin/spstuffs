<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SP Stuffs - 2-2 Simulator</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/scrolling-nav.css" rel="stylesheet">

	<!-- from http://davidbau.com/encode/seedrandom.js-->
	<script src="js/seedrandom.js"></script>
	
	<style>
/* For tables */
.small td{
	padding: 6px;
}
.small th{
	padding: 6px;
}
.highlight{
	color: white;
	background-color:#007bff!important;
}
/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    padding-top: 100px; /* Location of the box */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
}

/* The Close Button */
.close {
    color: #aaaaaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}
</style>

  </head>

  <body id="page-top">
  <!-- Why is spk such a troll? -->
<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span>
	<div class="row">
			<div class="col-lg-2 col-sm-0"></div>
	<div class="col-sm-4"> 
		<img id="okarin" src="https://media1.tenor.com/images/dab0d339e3e87e6dc7c96e68882f1007/tenor.gif" alt="okarin" class="img-fluid">
		<img id="mayushi" src="images/mayushi.png" alt="mayushi" style="width:100%" class="img-fluid">
	</div>
	<br>
	<div id="okarinMsg" class="col-sm-4">
	</div>
	</div>
  </div>

</div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">SP Stuffs</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <!-- <li class="nav-item"> -->
              <!-- <a class="nav-link js-scroll-trigger" href="#about">About</a> -->
            <!-- </li> -->
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#simulator">Simulator</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#about">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="22sim_ch.html">华语</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="bg-primary text-white">
      <div class="container text-center">
        <h1>SP Gen 2-2 Simulator</h1>
        <!--<p class="lead">A landing page template freshly redesigned for Bootstrap 4</p> -->
      </div>
    </header>

    <section id="simulator" >
      <div class="container">
		<div class="row">
			  <div class="col-lg-8 mx-auto">
				<h3>Select the environment (FM, Premium Card)</h3>
			  </div>
		</div>
		<div class="row">
			<div class="col-lg-2 col-sm-0"></div>
			<div class="col-lg-8 col-sm-8">
				<div class="checkbox">
  					<label><input type="checkbox" id="fm">&nbsp;Fusion Mania</label>
  				</div>
  			</div>
		</div>
		<div class="row">
			<div class="col-lg-2 col-sm-0"></div>
			<div class="col-lg-8 col-sm-8">
				<div class="checkbox">
  					<label><input type="checkbox" id="prem">&nbsp;Premium Card</label>
  				</div>
  			</div>
		</div>
		<div class="row">
			<div class="col-lg-2 col-sm-0"></div>
			<div class="col-lg-8 col-sm-8">
				<div class="checkbox">
  					<label><input type="checkbox" id="gf">&nbsp;Gold Force</label>
  				</div>
  			</div>
		</div>
	  
		<!-- <div class="row">
			<div class="col-lg-2 col-sm-0"></div>
			<div class="col-lg-2">Input your current %</div>
			<div class="col-lg-4">
				<input id="inputPercent" type="number" value="16" min="9" max="36" >
				<button id="22button" class="btn btn-primary" onclick="main()">2-2</button>
				<button id="clearBtn" class="btn"onclick="clearFunction()">Reset</button>
			</div>
		</div> -->

		<div class="row">
			<div class="col-lg-2 col-sm-0"></div>
			<div class="col-lg-6">
				<label for="inputPercent">Input your current %</label>
				<input class="form-control" id="inputPercent" type="number" value="16" min="9" max="36" >
			</div>
		</div>
		<br>
		<div class="row">
			<div class="col-lg-2 col-sm-0"></div>
			<div class="col-lg-4">

			<button id="22button" class="btn btn-primary" onclick="main()">2-2</button>
				<button id="clearBtn" class="btn"onclick="clearFunction()">Reset</button>
			</div>
		</div>
		
		<br>
		<div class="row">
			<div class="col-lg-2 col-sm-0"></div>
			<div class="col-lg-2">No. of tries:</div>
			<div class="col-lg-2"> <div id="count">0</div></div>
		</div>
		
		<div class="row">
			<div class="col-lg-2 col-sm-0"></div>
			<div class="col-lg-2">
				Roll:
			</div>
			<div class="col-lg-6">
				<p id="rollMsg"></p>
			</div>
		</div>
	  
		<div class="row">
			<div class="col-lg-8 mx-auto">
			<table id="22table" class="table table-striped small">
			    <thead>
			      <tr>
			        <th>Group</th>
			        <th>Roll</th>
			        <th>Max %</th>
			      </tr>
			    </thead>
			    <tbody>
			      <tr id="grp6">
			        <td>6</td>
			        <td>66-100</td>
			        <td>23</td>
			      </tr>
			      <tr id="grp5">
			        <td>5</td>
			        <td>36-65</td>
			        <td>25</td>
			      </tr>
			      <tr id="grp4">
			        <td>4</td>
			        <td>16-35</td>
			        <td>29</td>
			      </tr>
			      <tr id="grp3">
			        <td>3</td>
			        <td>6-15</td>
			        <td>33</td>
			      </tr>
			      <tr id="grp2">
			        <td>2</td>
			        <td>4-5</td>
			        <td>35</td>
			      </tr>
			      <tr id="grp1">
			        <td>1</td>
			        <td>3 and below</td>
			        <td>36</td>
			      </tr>
			    </tbody>
			  </table>

			</div>
		</div>
	  
		<div class="row">
			<div class="col-lg-2 col-sm-0"></div>
			<div class="col-lg-2"> 
				<p>New Percent</p>
			</div>
			<div class="col-lg-6"><p id="resultMsg"></p></div>
		</div>
      </div>
	</section>

    <section id="about" class="bg-light">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <h2>About</h2>
            <p class="lead">This simulator was developed to aid the understanding of how a 2-2 skill fusion works in SP Generations. The code for the 2-2 calculation was provided on 17th July 2018.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="py-5 bg-dark">
      <div class="container">
        <p class="m-0 text-center text-white">Copyright &copy; Sim Jiajin 2018</p>
      </div>
      <!-- /.container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom JavaScript for this theme -->
    <script src="js/scrolling-nav.js"></script>

  </body>

<script>
var sessionCount = 0;
Math.seedrandom(new Date());
function clearFunction(){
	//Hide group images.
	hideAllGroups();
	//Reset session counter
	sessionCount = 0;
	document.getElementById("count").innerHTML = sessionCount;
	//Print result and messages.
	document.getElementById("resultMsg").innerHTML = "";
	document.getElementById("rollMsg").innerHTML = "";
	//Update the current percent input field
	document.getElementById("inputPercent").value = 16;
	//Uncheck checkboxes
	document.getElementById("fm").checked = false;
	document.getElementById("prem").checked = false;
	document.getElementById("gf").checked = false;

}
function main(){
// Get the checkboxes
	var fm = document.getElementById("fm");
	var prem = document.getElementById("prem");
	var gf = document.getElementById("gf");
	  
	var currPercent = parseInt(document.getElementById("inputPercent").value);
	if(currPercent > 35)
	{
		alert("You shouldn't be 2-2ing a 36% item!");
		return;
	}
	
	//Increment session counter
	sessionCount = sessionCount + 1;
	
	var x = Math.floor((Math.random() * 100) + 1);
	var origRoll = x;
	var displayMsg = x;
	if (fm.checked == true)
	{
		x = x - 4;
		displayMsg = displayMsg + "<br>-4 From FusionMania Active "
	}
	if (prem.checked == true)
	{
		x = x - 8;
		displayMsg = displayMsg + "<br>-8 From Prem Card Active"
	}
	if (gf.checked == true)
	{
		x = x - 2;
		displayMsg = displayMsg + "<br>-2 From Gold Force"
	}
	if (currPercent >= 32)
	{
		x = x-10;
		displayMsg = displayMsg + "<br>-10 From Percent >= 32 "
	}else if (currPercent >= 28){
		x = x-7;
		displayMsg = displayMsg + "<br>-7 From Percent >= 29 "
	}else if (currPercent >= 24){
		x = x-3;
		displayMsg = displayMsg + "<br>-3 From Percent >= 25 "
	}
	  displayMsg = displayMsg + "<br>----<br>" + x +" Final roll" ;	
	var groupResult = getGroupFromRolledNo(x);
	
	var percentDisplayMsg = "";//Prepare explanation message
	var rolledPercent = parseInt(currPercent);
	if(x <= 3)	{
		//Grp 1		<=3
		rolledPercent = 36;

	} else if (x <= 5) {
		//Grp 2 	4-5

		var maxValue = 35;
		if (currPercent < maxValue)
		{
			rolledPercent = Math.floor((Math.random() * (maxValue - currPercent))) + 1 + currPercent;
			if (rolledPercent < currPercent)
				rolledPercent = currPercent;
		}

	}else if (x <= 15) {
		//Grp 3 	6 - 15

		var maxValue = 33;
		if (currPercent < maxValue)
		{
			rolledPercent = Math.floor((Math.random() * (maxValue - currPercent))) + 1 + currPercent;
			if (rolledPercent < currPercent)
				rolledPercent = currPercent;
		}

	}else if (x <= 35) {
		//Grp 4 	16 - 35

		var maxValue = 29;
		if (currPercent < maxValue)
		{
			rolledPercent = Math.floor((Math.random() * (maxValue - currPercent))) + 1 + currPercent;
			if (rolledPercent < currPercent)
				rolledPercent = currPercent;
		}

	}else if (x <= 65) {
		//Grp 5 	36 - 65

		var maxValue = 25;
		if (currPercent < maxValue)
		{
			rolledPercent = Math.floor((Math.random() * (maxValue - currPercent))) + 1 + currPercent;
			if (rolledPercent < currPercent)
				rolledPercent = currPercent;
		}

	}else{
		//Grp 6 	>65
		var maxValue = 23;
		if (currPercent < maxValue)
			rolledPercent += 1;
	}

	var newPercent = rolledPercent;
	//To handle the 5% chance of -2
	var crit = Math.floor((Math.random() * 100) + 1);
	if(crit <= 5)
	{
		newPercent--;
	}

	if(rolledPercent == 36){
		percentDisplayMsg = "You rolled Group "+ groupResult + ": 36 <br>New % : " + newPercent + "%";

	}else{
		percentDisplayMsg = "You rolled Group "+ groupResult + ", Max " + groupMax(groupResult) + ".<br>New % : " + newPercent + "%";
	}

	if(crit <=5)
	{
		//If crit, popup Okarin and modify display message accordingly.
		popupOkarin();
		percentDisplayMsg = "You rolled Group "+ groupResult + ", Max " + groupMax(groupResult) + " <br>New % : " + rolledPercent + "%<br>But Q pwned you! 5% chance of -1%.<br>New % : " + newPercent + "%";

		//Set popup msg
		document.getElementById("okarinMsg").innerHTML = percentDisplayMsg;
	}else if (newPercent == 36)
	{
		//If rolled 36, popup Mayushi
		popupMayushi();
		percentDisplayMsg = "You rolled 36% in " + sessionCount + " tries!";
		//Set popup msg
		document.getElementById("okarinMsg").innerHTML = percentDisplayMsg;
	}
	
	//CSS function to show the correct Image Group.
	showGroup(groupResult);
	
	document.getElementById("count").innerHTML = sessionCount;
	//Print result and messages.
	document.getElementById("resultMsg").innerHTML = percentDisplayMsg;
	document.getElementById("rollMsg").innerHTML = displayMsg;
	//Update the current percent input field
	document.getElementById("inputPercent").value = newPercent;
}

function getGroupFromRolledNo(roll) {
	var groupResult = 0;
	switch (true) {
    case (roll <= 3):
        groupResult=1;
        break;
    case (roll <= 5):
        groupResult=2;
        break;
    case (roll <= 15):
        groupResult=3;
        break;
    case (roll <= 35):
        groupResult=4;
        break;
    case (roll <= 65):
        groupResult=5;
        break;
    default:
        groupResult=6;
        break;
	}
	return groupResult;
}

function groupMax(groupNo){
	var maxValue = 0;
	switch (true) {
    case (groupNo <= 1):
        maxValue = 36;
        break;
    case (groupNo <= 2):
        maxValue = 35;
        break;
    case (groupNo <= 3):
        maxValue = 33;
        break;
    case (groupNo <= 4):
        maxValue = 29;
        break;
    case (groupNo <= 5):
        maxValue = 25;
        break;
    default:
		maxValue = 23;
        break;
	}
	return maxValue;
}
function hideAllGroups(){
    document.getElementById("grp1").classList.remove("highlight");
    document.getElementById("grp2").classList.remove("highlight");
    document.getElementById("grp3").classList.remove("highlight");
    document.getElementById("grp4").classList.remove("highlight");
    document.getElementById("grp5").classList.remove("highlight");
    document.getElementById("grp6").classList.remove("highlight");
}
function showGroup(grpId){
	hideAllGroups();
	var element = document.getElementById("grp" + grpId);
    element.classList.add("highlight");
}
document.getElementById("inputPercent")
    .addEventListener("keyup", function(event) {
    event.preventDefault();
    if (event.keyCode === 13) {
        document.getElementById("22button").click();
    }
});

</script>

<script>
//Popup window for Okarin
// Get the modal
var modal = document.getElementById('myModal');

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

function popupOkarin(){
    modal.style.display = "block";
    document.getElementById("mayushi").setAttribute("hidden", false);
    document.getElementById("okarin").removeAttribute("hidden");
	setTimeout(function(){closePopup()}, 3500);
}

function popupMayushi(){
    modal.style.display = "block";
    document.getElementById("okarin").setAttribute("hidden", false);
    document.getElementById("mayushi").removeAttribute("hidden");
	setTimeout(function(){closePopup()}, 3500);
}
function closePopup()
{
	modal.style.display = "none";
}
// When the user clicks on <span> (x), close the modal
span.onclick = function() {
    closePopup();
}
// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
        closePopup();
    }
}
</script>
</html>
